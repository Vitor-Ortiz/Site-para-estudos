/* assets/js/pentest.js - Ferramentas de Hacking */

// 1. CIFRA DE CÉSAR
function cesarCipher(encode) {
    const input = document.getElementById('cesar-input').value;
    const shift = parseInt(document.getElementById('cesar-shift').value) || 3;
    const resultEl = document.getElementById('cesar-result');
    
    if(!input) return;

    let result = "";
    for (let i = 0; i < input.length; i++) {
        let char = input[i];
        
        if (char.match(/[a-z]/i)) {
            const code = input.charCodeAt(i);
            // Maiúscula ou Minúscula
            const base = (code >= 65 && code <= 90) ? 65 : 97;
            
            // Lógica de deslocamento (encode + / decode -)
            let newCode;
            if (encode) newCode = ((code - base + shift) % 26) + base;
            else newCode = ((code - base - shift + 26) % 26) + base; // +26 para evitar negativo
            
            char = String.fromCharCode(newCode);
        }
        result += char;
    }
    
    resultEl.innerText = result;
    if(window.playSoundGlobal) window.playSoundGlobal('click');
}

// 2. BASE64
function base64Action(encode) {
    const input = document.getElementById('base64-input').value;
    const res = document.getElementById('base64-result');
    
    try {
        res.innerText = encode ? btoa(input) : atob(input);
        if(window.playSoundGlobal) window.playSoundGlobal('success');
    } catch(e) {
        res.innerText = "Erro: String inválida para Base64.";
        if(window.playSoundGlobal) window.playSoundGlobal('error');
    }
}

// 3. TERMINAL SIMULADO
const termInput = document.getElementById('terminal-input');
const termOutput = document.getElementById('terminal-output');

if(termInput) {
    termInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const cmd = termInput.value.trim().toLowerCase();
            termInput.value = '';
            printLine(`$ ${cmd}`, 'white');
            processCommand(cmd);
        }
    });
}

function printLine(text, color = '#ccc') {
    const div = document.createElement('div');
    div.className = 'line';
    div.style.color = color;
    div.innerText = text;
    termOutput.appendChild(div);
    termOutput.scrollTop = termOutput.scrollHeight; // Auto-scroll
}

function processCommand(cmd) {
    switch(cmd) {
        case 'help':
            printLine('Comandos disponíveis:', '#ef4444');
            printLine('- whoami : Mostra usuário atual');
            printLine('- clear : Limpa o terminal');
            printLine('- hack : Inicia simulação de ataque');
            printLine('- date : Mostra data do sistema');
            break;
        case 'whoami':
            const user = window.currentUser ? (window.currentUser.displayName || 'root') : 'guest';
            printLine(user, '#4ade80');
            break;
        case 'clear':
            termOutput.innerHTML = '';
            break;
        case 'date':
            printLine(new Date().toString(), '#facc15');
            break;
        case 'hack':
            printLine('Iniciando força bruta...', '#facc15');
            setTimeout(() => printLine('[*] Alvo localizado: 192.168.1.5', '#ef4444'), 800);
            setTimeout(() => printLine('[*] Portas abertas: 80, 443, 22', '#ef4444'), 1600);
            setTimeout(() => printLine('[+] ACESSO CONCEDIDO. +10 XP', '#4ade80'), 2500);
            setTimeout(() => { 
                if(window.adicionarXP) window.adicionarXP(10); 
                if(window.playSoundGlobal) window.playSoundGlobal('success');
            }, 2500);
            break;
        case '':
            break;
        default:
            printLine(`Comando não encontrado: ${cmd}`, '#ef4444');
    }
}