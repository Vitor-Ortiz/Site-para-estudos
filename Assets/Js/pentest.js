/* assets/js/pentest.js - V5 (XP Único + Flags Dinâmicas) */

let sessionHistory = [];
let missaoAtual = "missao_01";
let missoesConcluidas = new Set(); // Lista de IDs de missões já ganhas

// Estado Dinâmico
let gabaritoAtual = "FLAG{DEVSTUDY_INITIATE}"; // Resposta correta (muda na missão 2)
let segredoCriptografado = ""; // O que aparece no terminal (muda na missão 2)

// ==========================================
// 1. SISTEMA DE MISSÕES
// ==========================================

function mudarMissao() {
    const selector = document.getElementById('mission-selector');
    missaoAtual = selector.value;
    
    // Reset Total
    const termOutput = document.getElementById('terminal-output');
    termOutput.innerHTML = '';
    sessionHistory = [];
    
    // Configuração por Missão
    if (missaoAtual === 'missao_01') {
        gabaritoAtual = "FLAG{DEVSTUDY_INITIATE}";
        segredoCriptografado = ""; // Não usa na missão 1
        printLine(`--- INICIANDO MISSÃO 01 (FÁCIL) ---`, '#facc15');
    } 
    else if (missaoAtual === 'missao_02') {
        gerarFlagDinamicaMissao2(); // Gera uma nova senha aleatória
        printLine(`--- INICIANDO MISSÃO 02 (MÉDIO) ---`, '#facc15');
        printLine(`[SYSTEM] Nova chave criptográfica gerada.`, '#666');
    }

    mostrarNotificacao(`Ambiente carregado: ${missaoAtual}`, 'info');
}

function gerarFlagDinamicaMissao2() {
    // 1. Gera 4 letras aleatórias (Ex: ABXY)
    const randomChars = Math.random().toString(36).substring(2, 6).toUpperCase();
    
    // 2. Define a resposta certa (Ex: FLAG{CRYPTO_ABXY})
    gabaritoAtual = `FLAG{CRYPTO_${randomChars}}`;
    
    // 3. Criptografa para o Terminal (Ex: IODJ{FUBSWR_DEAB})
    // Usa a função local cesarLogic para calcular o segredo com Shift +3
    segredoCriptografado = cesarLogic(gabaritoAtual, true, 3);
    
    console.log("Gabarito (Dev):", gabaritoAtual); // Pra você testar fácil no F12
}

function verificarFlag() {
    const input = document.getElementById('flag-input');
    const userFlag = input.value.trim();
    const btn = document.querySelector('.btn-submit-flag');

    if (!userFlag) return;

    // VERIFICAÇÃO DE RESPOSTA
    if (userFlag === gabaritoAtual) {
        
        // TRAVA DE XP REPETIDO
        if (missoesConcluidas.has(missaoAtual)) {
            mostrarNotificacao("Você já completou essa missão!", "info");
            printLine(`\n[INFO] Flag correta, mas XP já foi resgatado.`, '#666');
            input.value = "";
            return;
        }

        // VITÓRIA INÉDITA
        missoesConcluidas.add(missaoAtual); // Marca como feita
        
        mostrarNotificacao("FLAG CORRETA! +150 XP", "success");
        printLine(`\n[SUCCESS] FLAG CONFIRMADA: ${userFlag}`, '#4ade80');
        
        if (window.adicionarXP) {
            window.adicionarXP(150);
            printLine(`[SYSTEM] 150 XP creditados.`, '#facc15');
        }

        // UI de Sucesso
        input.value = "";
        input.placeholder = "MISSÃO CUMPRIDA!";
        input.style.borderColor = "#4ade80";
        input.disabled = true;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = "#4ade80";
        
        if(window.playSoundGlobal) window.playSoundGlobal('success');
        
        setTimeout(() => { 
            input.disabled = false;
            btn.innerHTML = 'ENVIAR'; 
            btn.style.background = ""; 
            input.style.borderColor = "#333";
            input.placeholder = "Cole a FLAG aqui...";
        }, 3000);
        
    } else {
        // ERRO
        mostrarNotificacao("Flag Incorreta.", "error");
        printLine(`\n[FAIL] Inválido: ${userFlag}`, '#ef4444');
        if(window.playSoundGlobal) window.playSoundGlobal('error');
        
        input.style.borderColor = "#ef4444";
        setTimeout(() => input.style.borderColor = "#333", 1000);
    }
}

// ==========================================
// 2. FERRAMENTAS (Lógica Reutilizável)
// ==========================================

// Função pura de lógica (sem mexer no DOM) para usarmos internamente
function cesarLogic(text, encode, shift) {
    let result = "";
    for (let i = 0; i < text.length; i++) {
        let char = text[i];
        if (char.match(/[a-z]/i)) {
            const code = text.charCodeAt(i);
            const base = (code >= 65 && code <= 90) ? 65 : 97;
            let newCode = encode ? ((code - base + shift) % 26) + base : ((code - base - shift + 26) % 26) + base;
            result += String.fromCharCode(newCode);
        } else result += char;
    }
    return result;
}

// Funções da Interface (Botões)
function cesarCipher(encode) {
    const input = document.getElementById('cesar-input').value;
    const shift = parseInt(document.getElementById('cesar-shift').value) || 3;
    const resultEl = document.getElementById('cesar-result');
    if(!input) return;

    resultEl.innerText = cesarLogic(input, encode, shift);
    if(window.playSoundGlobal) window.playSoundGlobal('click');
}

function base64Action(encode) {
    const input = document.getElementById('base64-input').value;
    const res = document.getElementById('base64-result');
    try {
        res.innerText = encode ? btoa(input) : atob(input);
        if(window.playSoundGlobal) window.playSoundGlobal('success');
    } catch(e) { res.innerText = "Erro."; }
}

// ==========================================
// 3. TERMINAL INTELIGENTE
// ==========================================
const termInput = document.getElementById('terminal-input');
const termOutput = document.getElementById('terminal-output');
let isProcessing = false;

if(document.querySelector('.terminal-card')) {
    document.querySelector('.terminal-card').addEventListener('click', () => { if(termInput) termInput.focus(); });
}

if(termInput) {
    termInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && !isProcessing) {
            const cmd = termInput.value;
            if (!cmd.trim()) return;
            printLine(`root@kali:~$ ${cmd}`, 'white');
            termInput.value = '';
            isProcessing = true;
            await processarComando(cmd);
            isProcessing = false;
            termOutput.scrollTop = termOutput.scrollHeight;
        }
    });
}

function printLine(text, color = '#ccc') {
    const div = document.createElement('div');
    div.className = 'line';
    div.style.color = color;
    div.style.whiteSpace = 'pre-wrap';
    div.style.fontFamily = "'Fira Code', monospace";
    div.innerText = text;
    termOutput.appendChild(div);
}

async function processarComando(cmdRaw) {
    const cmd = cmdRaw.trim();
    if (cmd.toLowerCase() === 'clear') { termOutput.innerHTML = ''; sessionHistory = []; return; }
    if (cmd.toLowerCase() === 'help') { printLine('Comandos: nmap, ls, cat...', '#ef4444'); return; }

    printLine('executing...', '#444');
    const historicoTexto = sessionHistory.slice(-6).join("\n");

    try {
       const response = await fetch('https://devstudy-api.onrender.com/simular_terminal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                comando: cmd,
                historico: historicoTexto,
                missao_id: missaoAtual,
                segredo_dinamico: segredoCriptografado // <--- ENVIA O SEGREDO GERADO AQUI
            })
        });

        termOutput.lastChild.remove(); 
        if (!response.ok) throw new Error("Offline");

        const data = await response.json();
        const outputIA = data.output;
        
        printLine(outputIA, '#4ade80'); 
        
        sessionHistory.push(`User: ${cmd}`);
        sessionHistory.push(`Terminal: ${outputIA}`);

    } catch (error) {
        if(termOutput.lastChild) termOutput.lastChild.remove();
        printLine("❌ Erro: Servidor Python desligado.", '#ef4444');
    }
}

// UI Helpers (Toast)
function mostrarNotificacao(mensagem, tipo) {
    const div = document.createElement('div');
    div.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); padding:15px 25px; border-radius:8px; color:white; font-weight:bold; z-index:9999; box-shadow:0 4px 15px rgba(0,0,0,0.5); font-family:'Fira Code'; animation:fadeInDown 0.5s ease;";
    div.style.background = tipo === 'success' ? '#22c55e' : (tipo === 'error' ? '#ef4444' : '#3b82f6');
    div.innerHTML = mensagem;
    document.body.appendChild(div);
    setTimeout(() => { div.style.opacity='0'; setTimeout(()=>div.remove(),500); }, 3000);
}

// Inject CSS Animation
const styleSheet = document.createElement("style");
styleSheet.innerText = `@keyframes fadeInDown { from { opacity:0; transform:translate(-50%, -20px); } to { opacity:1; transform:translate(-50%, 0); } }`;
document.head.appendChild(styleSheet);